#
# Centralized WiFi Roaming Platform
# - FreeRADIUS is the ONLY authority for access decisions.
# - Wallet + sessions stored in PostgreSQL.
#

centralwifi_authorize {
  # For station-less tests, make sure Calling-Station-Id is always present.
  if (!&Calling-Station-Id) {
    update request {
      Calling-Station-Id := "%{Client-IP-Address}"
    }
  }

  # Load password for PAP / EAP-TTLS(PAP). (WPA2-Enterprise clients use EAP-TTLS/PEAP.)
  update control {
    # Username is an E.164 phone number; avoid complex escaping and enforce format at the API layer.
    Cleartext-Password := "%{sql:SELECT radius_password FROM users WHERE username = '%{User-Name}' AND status = 'ACTIVE'}"
  }

  if (!control:Cleartext-Password) {
    update reply {
      Reply-Message := "Unknown user"
    }
    reject
  }

  # Enforce wallet + single-device policy via DB function.
  #
  # Optional: if WALLED_GARDEN_ON_NO_CREDIT=1 and the reject reason is "No active plan",
  # accept the user into a restricted VLAN so they can reach /portal to top up.
  if ("%{sql:SELECT cw_radius_is_allowed('%{User-Name}','%{Calling-Station-Id}', %{env:ACTIVE_SESSION_GRACE_SECONDS})}" != "t") {
    update control {
      Tmp-String-1 := "%{sql:SELECT cw_radius_reject_message('%{User-Name}','%{Calling-Station-Id}', %{env:ACTIVE_SESSION_GRACE_SECONDS})}"
      Tmp-String-2 := "%{sql:SELECT COALESCE((SELECT value FROM system_settings WHERE key = 'walled_garden_on_no_credit'),'0')}"
    }

    if (control:Tmp-String-2 == "1" && control:Tmp-String-1 == "No active plan") {
      update reply {
        Tunnel-Type := VLAN
        Tunnel-Medium-Type := IEEE-802
        Tunnel-Private-Group-Id := "%{sql:SELECT COALESCE((SELECT value FROM system_settings WHERE key = 'walled_garden_vlan_id'),'0')}"
        Filter-Id := "WALLED_GARDEN"
        Reply-Message := "No active plan (walled garden). Open /portal to top up."
        Session-Timeout := 300
      }
    } else {
      update reply {
        Reply-Message := "%{control:Tmp-String-1}"
      }
      reject
    }
  }

  # Encourage periodic re-auth for TIME plans.
  update reply {
    Session-Timeout := "%{sql:SELECT cw_radius_session_timeout_seconds('%{User-Name}')}"
  }
}

centralwifi_post_auth {
  # Create/refresh an active session immediately on Access-Accept to close the auth/accounting race.
  update control {
    Tmp-Integer-0 := "%{sql:SELECT cw_radius_touch_session('%{User-Name}','%{Calling-Station-Id}','%{Client-IP-Address}','%{%{Acct-Session-Id}:-}')}"
  }
}

centralwifi_accounting {
  # Map accounting events to our sessions/wallet logic.
  update control {
    Tmp-String-0 := "%{sql:SELECT cw_radius_accounting('%{User-Name}','%{Calling-Station-Id}','%{Client-IP-Address}','%{%{Acct-Session-Id}:-}','%{Acct-Status-Type}')}"
  }
}
